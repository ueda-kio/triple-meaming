# アプリケーション開発仕様書

## 0. ドキュメント概要

このドキュメントは、AI開発エージェントが新規Webアプリケーション「**トリプルミーミング**」を開発するために必要な、ユーザー要求、システム要件、そして**データフローや主要技術の実装指針を含む詳細な基本設計**を定義するものです。エージェントは、この仕様書に基づき、開発タスクの計画と実行を行ってください。

## Part 1: 要求整理 (User Requirements)

### 1.1. アプリのコンセプト

* 3つの楽曲を同時に再生し、それぞれの楽曲名を当てる音楽クイズアプリケーション。

### 1.2. ユーザー要求リスト

* クイズは全5問で構成される。  
* クイズ開始前に、アーティストのアルバム単位で楽曲の出題範囲をユーザーが選択できる。  
* クイズを開始するとクイズ画面に遷移し、再生ボタンのクリックで3つの楽曲が同時に再生される。  
* 楽曲は、ユーザーが設定した出題範囲の中からランダムに3曲が選ばれる。  
* ユーザーは、1曲ずつ選択式で楽曲名を回答する。  
* 回答するたびに、都度その場で正解か不正解かが表示される。  
* 「答えを見る」ボタンをクリックすると、その問題の正解である3曲すべてが表示される。  
* 「3曲すべてに正解する」または「答えを見る」を選択すると、次の問題に進むことができる。

## Part 2: 要件定義 (System Requirements Definition)

### 2.1. アプリ概要

* **アプリ名:** トリプルミーミング

### 2.2. システム要件

#### 2.2.1. 技術スタック

* **フレームワーク:** Next.js (v15, App Router)  
* **言語:** TypeScript  
* **スタイリング:** CSS Modules  
* **テスト:** Jest, MSW (Mock Service Worker)  
* **フォーマッタ/リンター:** Biome  
* **パッケージマネージャー:** pnpm  
* **ホスティング:** Vercel

#### 2.2.2. データ管理

* 楽曲データは、静的JSONファイル public/songs.json で管理する。  
* データ構造は以下の形式に従うこと。

コード スニペット

```json
{  
  "artists": \[  
    {  
      "id": "artist001",  
      "name": "BUMP OF CHICKEN",  
      "albums": \[  
        {  
          "id": "album001",  
          "name": "FLAME VEIN",  
          "jacketUrl": "/images/image\_album001.png",  
          "tracks": \[  
            {  
              "id": "track001",  
              "title": "ガラスのブルース",  
              "youtubeUrl": "..."  
            },  
            {  
              "id": "track002",  
              "title": "くだらない唄",  
              "youtubeUrl": "...",  
              "duration": 120  
            }  
          \]  
        }  
      \]  
    }  
  \]  
}
```

### 2.3. 機能要件

#### 2.3.1. 出題範囲設定機能

* **UI:** 設定機能はモーダルウィンドウ内に実装する。トップページの設定ボタンクリックでモーダルを開く。  
* **URL連携:** 選択されたアルバムIDは、URLのクエリパラメータ (?albums=album001,album002) で管理する。

#### 2.3.2. クイズ実行機能

* **問題構成:** クイズは全5問とする。  
* **楽曲再生:**  
  * **API:** YouTube IFrame Player API を利用する。  
  * **同期:** 3つの楽曲は、再生ボタンのクリックと**同時に再生を開始し、指定時間経過後に同時に停止すること**を保証する。  
  * **プリロード:** 上記の同期を実現するため、再生前に必ず各楽曲のプリロードを完了させること。

#### 2.3.3. 回答・判定機能

* **UI:** 各曲の回答は、ボタンクリックで専用の回答用モーダルを開いて行う。  
* **回答モーダル:** 左右2ペイン構成（左:アルバムリスト、右:楽曲リスト）とする。

## Part 3: 基本設計 (High-Level Design)

### 3.1. コンポーネントアーキテクチャ

* アプリケーションは、以下の主要コンポーネントから構成される。

#### 3.1.1. トップ/出題範囲設定画面 (SelectAlbumsPage)

* **SelectAlbumsPage (ページ):**  
  * ヘッダー、設定モーダルを開くボタン、クイズ開始ボタンを配置する。  
  * **AlbumSelectModal (モーダル):**  
    * 出題範囲を選択するUI（アーティストリスト、アルバムカード）を内包する。

#### 3.1.2. クイズ画面 (QuizPage)

* **QuizPage (ページ):**  
  * **QuizContainer (コンテナ):** クイズ全体のロジック、状態管理、進行制御、**次問のプリロード**を担当する。  
  * **AnswerModal (モーダル):** 2ペインの回答選択用UI。  
  * **YouTubePlayerWrapper (技術コンポーネント):** 3つインスタンス化し、3曲同時再生を実現する。

#### 3.1.3. 結果画面 (ResultPage)

* **ResultPage (ページ):** クイズ終了メッセージと、トップページに戻るボタンを配置する。

### 3.2. データフロー設計

* 主要な機能におけるデータフローは以下の通り。

#### 3.2.1. クイズ設定と開始

```
sequenceDiagram  
    participant User as ユーザー  
    participant Page as トップページ  
    participant Modal as AlbumSelectModal  
    participant URL

    User-\>\>Page: アプリにアクセス  
    Page-\>\>Modal: モーダルを開く  
    User-\>\>Modal: アルバムを選択/解除  
    Modal-\>\>URL: クエリパラメータを更新 (\`?albums=...\`)  
    User-\>\>Page: 「クイズ開始」クリック → /quiz へ画面遷移
```

#### 3.2.2. クイズ実行とプリロード

```
sequenceDiagram  
    participant QuizContainer  
    participant Player as YouTubePlayer x3

    QuizContainer-\>\>QuizContainer: (初期化) 全5問分の問題セットを生成  
    QuizContainer-\>\>Player: 1問目の3曲を再生準備  
    QuizContainer-\>\>Player: \*\*2問目の3曲をプリロード (cueVideoById)\*\*

    User-\>\>QuizContainer: 「次の問題へ」クリック  
    QuizContainer-\>\>Player: 2問目の3曲を再生準備  
    QuizContainer-\>\>Player: \*\*3問目の3曲をプリロード (cueVideoById)\*\*
```
より詳細は YouTube_Iframe_Guide.md を参照。

### 3.3. 主要技術の実装指針

#### 3.3.1. 楽曲再生機能 (YouTube IFrame Player API)

* **基本方針:** 提供された「YouTube IFrame Player API 実装ガイド & プリロード最適化」のベストプラクティスに準拠して実装する。  
* **プリロード戦略:**  
  * cueVideoById メソッドを活用し、ユーザーが現在の問題を解いている間に、**次の問題で使う3曲を必ずプリロード**しておく。これにより、再生ボタンクリック時の読み込み遅延をなくし、「厳密な同時再生」という要件を達成する。  
  * プリロード状態はコンポーネントのStateで管理し、再生ボタンは全曲のプリロードが完了するまで非活性にする等の制御を行う。  
* **再生制御:**  
  * playVideo() / pauseVideo() / seekTo() を用いて再生を制御する。  
  * プリロード済みの動画を再生する場合は、seekTo() で指定時間に移動後、playVideo() を呼び出すことで高速に再生を開始する。  
* **カプセル化:**  
  * useYouTubePlayer のようなReactカスタムフックを作成し、プレイヤーの初期化、状態管理（isPlayerReady, isPlaying等）、再生・停止・プリロードといった複雑なロジックをカプセル化する。これにより、コンポーネントの見通しを良くし、保守性を高める。  
* **エラーハンドリング:**  
  * プレイヤーの初期化失敗や動画の再生エラーに備え、リトライ処理や、ユーザーへのエラー通知、代替コンテンツの表示などのフォールバック処理を実装し、アプリケーションの堅牢性を高める。